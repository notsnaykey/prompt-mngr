<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Manager for LLMs</title>
    <!-- Quill.js for rich text editing -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.snow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.min.js"></script>
    <style>
        /* Basic reset and dark mode styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            line-height: 1.4;
            padding: 10px;
        }
        .container {
            display: grid;
            grid-template-columns: 180px 220px 1fr;
            max-width: 100%;
            margin: 0 auto;
            gap: 10px;
            height: calc(100vh - 20px);
        }
        .sidebar {
            background-color: #1e1e1e;
            padding: 10px;
            border-radius: 8px;
            overflow-y: auto;
        }
        .summary-panel {
            background-color: #1e1e1e;
            padding: 10px;
            border-radius: 8px;
            overflow-y: auto;
        }
        .summary-panel h2 {
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #444;
        }
        .main-content {
            background-color: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .subcategory-container {
            display: flex;
            flex-grow: 1;
            margin-top: 10px;
        }
        .subcategory-list {
            width: 160px;
            margin-right: 15px;
            padding-right: 10px;
            border-right: 1px solid #333;
        }
        .text-boxes-container {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .content-area-grid {
            display: flex;
            flex-grow: 1;
            flex-direction: column;
        }
        .text-boxes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .text-boxes-panel {
            background-color: #232323;
            border-radius: 8px;
            padding: 10px;
            overflow-y: auto;
            flex-grow: 1;
            min-height: 200px; /* Ensure there's always visible space */
        }
        h1, h2, h3 {
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        h1 {
            font-size: 1.2em;
        }
        h2 {
            font-size: 1.1em;
        }
        ul {
            list-style: none;
            margin-bottom: 8px;
        }
        li {
            padding: 5px 0;
            cursor: pointer;
            transition: color 0.3s;
        }
        li:hover {
            color: #bb86fc;
        }
        .active {
            color: #bb86fc;
            font-weight: bold;
        }
        .content-placeholder {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        
        /* Search styles */
        #search-container {
            margin-bottom: 15px;
            background-color: #232323;
            padding: 10px;
            border-radius: 8px;
        }
        .search-box {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }
        .search-box input {
            flex: 1;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: #333;
            color: #e0e0e0;
            font-size: 0.9em;
        }
        .search-box button {
            background-color: #bb86fc;
            color: #121212;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .filter-options {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        .filter-options select {
            padding: 4px;
            border-radius: 4px;
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #444;
            font-size: 0.9em;
        }
        
        /* When no entries are available, show a prompt */
        .empty-state {
            text-align: center;
            padding: 20px;
            color: #aaa;
            font-style: italic;
        }
        .empty-state p {
            margin-bottom: 15px;
        }
        
        /* Search results */
        .search-results {
            margin-top: 20px;
            padding: 15px;
            background-color: #232323;
            border-radius: 8px;
        }
        .result-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #444;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-header {
            margin-bottom: 5px;
            font-weight: bold;
            color: #bb86fc;
        }
        
        /* Content box styles */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .add-btn {
            background-color: #bb86fc;
            color: #121212;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
        }
        .text-box {
            background-color: #2d2d2d;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            transition: all 0.3s;
            border-left: 4px solid transparent;
            width: 100%;
        }
        .text-box.completed {
            opacity: 0.6;
            background-color: #222;
        }
        .text-box.good {
            background-color: rgba(0, 128, 0, 0.15);
            border-left-color: #4caf50;
        }
        .text-box-controls {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 5px;
            font-size: 0.85em;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .delete-btn {
            background-color: #cf6679;
            color: #121212;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .view-btn {
            background-color: #03dac6;
            color: #121212;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* Back button styles */
        .back-btn {
            background-color: #555;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 0.9em;
        }
        .back-btn:hover {
            background-color: #666;
        }
        
        /* Editor styles */
        .rich-text-editor {
            margin-bottom: 15px;
            border-radius: 4px;
            background-color: #333;
        }
        .ql-container.ql-snow {
            border-color: #444;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
            color: #e0e0e0;
            min-height: 60px;
            max-height: 150px;
            overflow-y: auto;
        }
        .ql-toolbar.ql-snow {
            background-color: #2a2a2a;
            border-color: #444;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            padding: 4px;
        }
        .ql-editor {
            padding: 8px;
            font-size: 0.9em;
        }
        .ql-editor.ql-blank::before {
            color: #999;
            font-style: italic;
            font-size: 0.9em;
        }
        
        /* Summary panel styles */
        .summary-item {
            background-color: #2d2d2d;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 5px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .summary-item:hover {
            background-color: #333;
        }
        .summary-item.completed {
            opacity: 0.6;
            background-color: #222;
            text-decoration: line-through;
        }
        .summary-item.good {
            background-color: rgba(0, 128, 0, 0.2);
            border-left-color: #4caf50;
        }
        .summary-content {
            color: #aaa;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            font-size: 0.8em;
            line-height: 1.3;
        }
        .summary-status {
            margin-top: 5px;
            font-size: 0.8em;
            display: flex;
            justify-content: space-between;
        }
        .status-dot {
            height: 8px;
            width: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.completed {
            background-color: #888;
        }
        .status-dot.good {
            background-color: #4caf50;
        }
        
        /* Export/Import buttons */
        .data-controls {
            position: fixed;
            right: 10px;
            bottom: 10px;
            display: flex;
            gap: 10px;
        }
        .data-btn {
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #555;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
        }
        .data-btn:hover {
            background-color: #444;
        }
        .subcategory-info {
            padding-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>Models</h2>
            <ul id="categories">
                <!-- Models will be populated here -->
            </ul>
        </div>
        <div class="summary-panel">
            <h2>All Entries</h2>
            <div id="summary-list">
                <!-- Summaries will be displayed here -->
            </div>
        </div>
        <div class="main-content">
            <h1 id="selected-category">Select a model</h1>
            
            <!-- Hidden subcategory selection - not displayed but needed for JavaScript -->
            <div id="subcategory-selection" style="display: none; position: absolute; visibility: hidden; height: 0; overflow: hidden;">
                <ul id="subcategories"></ul>
            </div>
            
            <div id="content-area">
                <div class="content-placeholder">
                    Select a model and behavior to begin
                </div>
            </div>
            
            <div class="content-area-grid" id="content-area-grid" style="display: none;">
                <div class="search-container" id="search-container" style="display: none;">
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="Search entries...">
                        <button id="search-btn">Search</button>
                    </div>
                    <div class="filter-options">
                        <label for="subcategory-filter">Filter by behavior:</label>
                        <select id="subcategory-filter">
                            <option value="all">All Behaviors</option>
                        </select>
                    </div>
                </div>
                
                <div class="subcategory-container">
                    <div class="subcategory-list">
                        <h3>Behaviors</h3>
                        <ul id="subcategories-side">
                            <!-- Behaviors will be populated here -->
                        </ul>
                    </div>
                    
                    <div class="text-boxes-container">
                        <div class="text-boxes-header">
                            <h3 id="content-title">Model > Behavior</h3>
                            <button id="add-box-btn" class="add-btn">+ Add Text Box</button>
                        </div>
                        <div class="text-boxes-panel" id="text-boxes">
                            <!-- Text boxes will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="data-controls">
        <button id="export-btn" class="data-btn">Export Data</button>
        <button id="import-btn" class="data-btn">Import Data</button>
        <input type="file" id="import-file" style="display: none;" accept=".json">
    </div>

    <script>
        // [Quill Instance Cleanup] Map to track Quill instances for cleanup
        const quillInstances = new Map();

        // [XSS Vulnerability] Helper function to escape HTML for safe rendering
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Sample data - easily replaceable
        const defaultData = {
            categories: Array.from({ length: 20 }, (_, i) => `Model ${i+1}`),
            subcategories: Array.from({ length: 9 }, (_, i) => `Behavior ${i+1}`),
            entries: {},
            version: '1.1'
        };

        // Initialize local storage if needed
        if (!localStorage.getItem('categoryAppData')) {
            localStorage.setItem('categoryAppData', JSON.stringify(defaultData));
        } else {
            const storedData = JSON.parse(localStorage.getItem('categoryAppData'));
            let needsUpdate = false;
            
            // Ensure subcategories exist
            if (!storedData.subcategories || storedData.subcategories.length === 0) {
                storedData.subcategories = defaultData.subcategories;
                needsUpdate = true;
            }
            
            // Check if categories use "Category" instead of "Model"
            if (storedData.categories && storedData.categories.length > 0 && storedData.categories[0].startsWith('Category')) {
                storedData.categories = storedData.categories.map(cat => cat.replace('Category', 'Model'));
                needsUpdate = true;
            }
            
            // Check if subcategories use "Subcategory" instead of "Behavior"
            if (storedData.subcategories && storedData.subcategories.length > 0 && storedData.subcategories[0].startsWith('Subcategory')) {
                storedData.subcategories = storedData.subcategories.map(sub => sub.replace('Subcategory', 'Behavior'));
                needsUpdate = true;
            }
            
            if (needsUpdate) {
                const newEntries = {};
                Object.keys(storedData.entries).forEach(key => {
                    const parts = key.split('-');
                    if (parts.length === 2) {
                        const oldCategory = parts[0];
                        const oldSubcategory = parts[1];
                        const newCategory = oldCategory.replace('Category', 'Model');
                        const newSubcategory = oldSubcategory.replace('Subcategory', 'Behavior');
                        const newKey = `${newCategory}-${newSubcategory}`;
                        newEntries[newKey] = storedData.entries[key].map(entry => {
                            let plainText = '';
                            try {
                                if (entry.text && typeof entry.text === 'string' && entry.text.startsWith('{')) {
                                    const contentObj = JSON.parse(entry.text);
                                    if (contentObj.ops) {
                                        plainText = contentObj.ops
                                            .map(op => typeof op.insert === 'string' ? op.insert : '')
                                            .join('');
                                    } else {
                                        plainText = entry.text;
                                    }
                                } else {
                                    plainText = entry.text || '';
                                }
                            } catch (e) {
                                plainText = entry.text || '';
                            }
                            return { ...entry, plainText };
                        });
                    } else {
                        newEntries[key] = storedData.entries[key];
                    }
                });
                storedData.entries = newEntries;
                storedData.version = '1.1';
                localStorage.setItem('categoryAppData', JSON.stringify(storedData));
            }
        }

        // DOM Elements
        const categoriesList = document.getElementById('categories');
        const subcategoriesList = document.getElementById('subcategories');
        const selectedCategoryTitle = document.getElementById('selected-category');
        const subcategorySelection = document.getElementById('subcategory-selection');
        const contentArea = document.getElementById('content-area');

        // [LocalStorage Threshold] Check storage size before saving
        function checkStorageSize(data) {
            const size = new Blob([JSON.stringify(data)]).size / 1024 / 1024; // MB
            if (size > 4.5) { // More conservative 5MB limit
                alert('Storage nearing limit (~5 MB). Export and clear some data to continue.');
                return false;
            }
            return true;
        }

        // Populate categories with Model terminology
        function populateCategories() {
            const storedData = JSON.parse(localStorage.getItem('categoryAppData'));
            categoriesList.innerHTML = '';
            
            storedData.categories.forEach(category => {
                const li = document.createElement('li');
                li.textContent = category.replace('Category', 'Model');
                li.onclick = () => selectCategory(category);
                categoriesList.appendChild(li);
            });
        }

        // Select a category
        function selectCategory(category) {
            document.querySelectorAll('#categories li').forEach(item => {
                item.classList.remove('active');
            });
            
            const displayCategory = category.replace('Category', 'Model');
            document.querySelectorAll('#categories li').forEach(item => {
                if (item.textContent === displayCategory) {
                    item.classList.add('active');
                }
            });
            
            selectedCategoryTitle.textContent = displayCategory;
            
            document.getElementById('content-area').style.display = 'none';
            document.getElementById('content-area-grid').style.display = 'flex';
            document.getElementById('search-container').style.display = 'block';
            
            populateSubcategories(category);
            updateSubcategoryFilter();
            setupSearch(category);
            
            updateSummary(category, null);
            
            document.querySelector('.summary-panel h2').innerHTML = `${displayCategory} Entries`;
            
            document.querySelectorAll('.summary-item').forEach(item => {
                if (item.dataset.category === category) {
                    item.style.borderLeft = '3px solid #bb86fc';
                } else {
                    item.style.borderLeft = '';
                }
            });

            const activeBehavior = document.querySelector('#subcategories-side li.active')?.textContent;
            if (activeBehavior) {
                const rawBehavior = activeBehavior.replace('Behavior', 'Behavior');
                selectSubcategory(category, rawBehavior);
            }
        }
        
        // Update subcategory filter options
        function updateSubcategoryFilter() {
            const storedData = JSON.parse(localStorage.getItem('categoryAppData'));
            const subcategoryFilter = document.getElementById('subcategory-filter');
            
            while (subcategoryFilter.options.length > 1) {
                subcategoryFilter.remove(1);
            }
            
            storedData.subcategories.forEach(subcategory => {
                const option = document.createElement('option');
                option.value = subcategory;
                option.textContent = subcategory;
                subcategoryFilter.appendChild(option);
            });
        }
        
        // Setup search functionality
        function setupSearch(category) {
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const subcategoryFilter = document.getElementById('subcategory-filter');
            
            searchInput.value = '';
            
            searchBtn.onclick = () => performSearch(category);
            searchInput.onkeyup = (e) => {
                if (e.key === 'Enter') {
                    performSearch(category);
                }
            };
            subcategoryFilter.onchange = () => performSearch(category);
        }

        // Display subcategories on the side list
        function populateSubcategories(category) {
            const storedData = JSON.parse(localStorage.getItem('categoryAppData'));
            console.log('Subcategories:', storedData.subcategories); // Debug log
            
            const sideSubcategoriesList = document.getElementById('subcategories-side');
            if (sideSubcategoriesList) {
                sideSubcategoriesList.innerHTML = '';
                
                storedData.subcategories.forEach(subcategory => {
                    const li = document.createElement('li');
                    li.textContent = subcategory.replace('Subcategory', 'Behavior');
                    li.onclick = () => selectSubcategory(category, subcategory);
                    sideSubcategoriesList.appendChild(li);
                });
            }
        }
        
        function displayContentArea(category, subcategory) {
            const key = `${category}-${subcategory}`;
            const storedData = JSON.parse(localStorage.getItem('categoryAppData'));
            
            if (!storedData.entries[key]) {
                storedData.entries[key] = [];
                localStorage.setItem('categoryAppData', JSON.stringify(storedData));
            }
            
            document.getElementById('content-area').style.display = 'none';
            const contentGrid = document.getElementById('content-area-grid');
            contentGrid.style.display = 'flex';
            
            document.getElementById('content-title').textContent = `${category.replace('Category', 'Model')} > ${subcategory.replace('Subcategory', 'Behavior')}`;
            
            document.getElementById('search-container').style.display = 'block';
            
            renderTextBoxes(category, subcategory);
            
            const displaySubcategory = subcategory.replace('Subcategory', 'Behavior');
            const subcategoriesList = document.getElementById('subcategories-side');
            subcategoriesList.querySelectorAll('li').forEach(item => {
                item.classList.toggle('active', item.textContent === displaySubcategory);
            });
            
            document.getElementById('selected-category').textContent = category.replace('Category', 'Model');
        }
        
        // Select a subcategory
        function selectSubcategory(category, subcategory) {
            document.querySelectorAll('#subcategories li').forEach(item => {
                item.classList.remove('active');
            });
            
            const displayCategory = category.replace('Category', 'Model');
            const displaySubcategory = subcategory.replace('Subcategory', 'Behavior');
            
            document.querySelectorAll('#subcategories li').forEach(item => {
                if (item.textContent === displaySubcategory) {
                    item.classList.add('active');
                }
            });
            
            document.getElementById('selected-category').textContent = displayCategory;
            
            displayContentArea(category, subcategory);
            
            updateSummary(category, subcategory);
        }
        
        // [Empty State Handling] Helper function for adding first entry
        function addFirstEntry(category, subcategory) {
            addNewTextBox(category, subcategory);
        }

        // Render text boxes for selected category/subcategory
        function renderTextBoxes(category, subcategory) {
            const key = `${category}-${subcategory}`;
            const storedData = JSON.parse(localStorage.getItem('categoryAppData'));
            const textBoxesContainer = document.getElementById('text-boxes');
            textBoxesContainer.innerHTML = '';

            // [Empty State Handling] Show empty state if no entries
            if (storedData.entries[key].length === 0) {
                textBoxesContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No entries found for this behavior.</p>
                        <button class="add-btn" onclick="addFirstEntry('${category}', '${subcategory}')">
                            Create First Entry
                        </button>
                    </div>
                `;
                return;
            }
            
            storedData.entries[key].forEach(entry => {
                const boxElement = document.createElement('div');
                boxElement.className = `text-box ${entry.completed ? 'completed' : ''} ${entry.good ? 'good' : ''}`;
                boxElement.dataset.id = entry.id;
                
                boxElement.innerHTML = `
                    <div id="editor-${entry.id}" class="rich-text-editor"></div>
                    <div class="text-box-controls">
                        <div class="checkbox-container">
                            <input type="checkbox" id="checkbox-${entry.id}" ${entry.completed ? 'checked' : ''}>
                            <label for="checkbox-${entry.id}">Mark as completed</label>
                        </div>
                        <div class="checkbox-container">
                            <input type="checkbox" id="good-${entry.id}" ${entry.good ? 'checked' : ''}>
                            <label for="good-${entry.id}">Mark as good</label>
                        </div>
                        <button class="delete-btn">Delete</button>
                    </div>
                `;
                
                textBoxesContainer.appendChild(boxElement);
                
                // [Quill Instance Cleanup] Create and store Quill instance
                const quill = new Quill(`#editor-${entry.id}`, {
                    theme: 'snow',
                    placeholder: 'Enter your text here...',
                    modules: {
                        toolbar: [
                            ['bold', 'italic', 'underline'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['clean']
                        ]
                    },
                    bounds: `#editor-${entry.id}`
                });
                quillInstances.set(entry.id, quill);
                
                if (entry.text) {
                    try {
                        quill.setContents(JSON.parse(entry.text));
                    } catch (e) {
                        quill.setText(entry.text);
                    }
                }
                
                quill.on('text-change', function() {
                    let scrollHeight = quill.root.scrollHeight;
                    if (scrollHeight > 60) {
                        let newHeight = Math.min(scrollHeight, 300);
                        quill.container.style.height = newHeight + 'px';
                    }
                    
                    const content = JSON.stringify(quill.getContents());
                    updateTextBox(category, subcategory, entry.id, content);
                    updateSummary(category, subcategory);
                });
                
                const checkbox = boxElement.querySelector('input[type="checkbox"]#checkbox-' + entry.id);
                checkbox.addEventListener('change', () => {
                    toggleComplete(category, subcategory, entry.id, checkbox.checked);
                    boxElement.classList.toggle('completed', checkbox.checked);
                    updateSummary(category, subcategory);
                });
                
                const goodCheckbox = boxElement.querySelector('input[type="checkbox"]#good-' + entry.id);
                goodCheckbox.addEventListener('change', () => {
                    toggleGood(category, subcategory, entry.id, goodCheckbox.checked);
                    boxElement.classList.toggle('good', goodCheckbox.checked);
                    updateSummary(category, subcategory);
                });
                
                const deleteBtn = boxElement.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', () => {
                    deleteTextBox(category, subcategory, entry.id);
                    boxElement.remove();
                    updateSummary(category, subcategory);
                });
            });
        }
        
        // Add a new text box
        function addNewTextBox(category, subcategory) {
            const key = `${category}-${subcategory}`;
            const storedData = JSON.parse(localStorage.getItem('categoryAppData'));
            
            const newEntry = {
                text: '',
                completed: false,
                good: false,
                id: Date.now(),
                plainText: ''
            };
            
            storedData.entries[key].push(newEntry);
            if (checkStorageSize(storedData)) {
                localStorage.setItem('categoryAppData', JSON.stringify(storedData));
                renderTextBoxes(category, subcategory);
                updateSummary(category, subcategory);

                // [New Entry Visibility] Scroll to the new text box
                setTimeout(() => {
                    const newBox = document.querySelector(`[data-id="${newEntry.id}"]`);
                    if (newBox) newBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }
        
        // Update text box content
        function updateTextBox(category, subcategory, id, text) {
            const key = `${category}-${subcategory}`;
            const storedData = JSON.parse(localStorage.getItem('categoryAppData'));
            
            const entryIndex = storedData.entries[key].findIndex(entry => entry.id == id);
            if (entryIndex !== -1) {
                const delta = JSON.parse(text);
                const plainText = delta.ops.map(op => typeof op.insert === 'string' ? op.insert : '').join('');
                storedData.entries[key][entryIndex].text = text;
                storedData.entries[key][entryIndex].plainText = plainText;
                if (checkStorageSize(storedData)) {
                    localStorage.setItem('categoryAppData', JSON.stringify(storedData));
                }
            }
        }
        
        // Toggle completion status
        function toggleComplete(category, subcategory, id, completed) {
            const key = `${category}-${subcategory}`;
            const storedData = JSON.parse(localStorage.getItem('categoryAppData'));
            
            const entryIndex = storedData.entries[key].findIndex(entry => entry.id == id);
            if (entryIndex !== -1) {
                storedData.entries[key][entryIndex].completed = completed;
                if (checkStorageSize(storedData)) {
                    localStorage.setItem('categoryAppData', JSON.stringify(storedData));
                }
            }
        }
        
        // Delete a text box
        function deleteTextBox(category, subcategory, id) {
            const key = `${category}-${subcategory}`;
            const storedData = JSON.parse(localStorage.getItem('categoryAppData'));
            
            // [Quill Instance Cleanup] Destroy Quill instance before deletion
            if (quillInstances.has(id)) {
                quillInstances.get(id).off('text-change'); // Remove event listeners
                quillInstances.delete(id);
            }
            
            const entryIndex = storedData.entries[key].findIndex(entry => entry.id == id);
            if (entryIndex !== -1) {
                storedData.entries[key].splice(entryIndex, 1);
                if (checkStorageSize(storedData)) {
                    localStorage.setItem('categoryAppData', JSON.stringify(storedData));
                }
            }
        }
        
        // Toggle "good" status
        function toggleGood(category, subcategory, id, good) {
            const key = `${category}-${subcategory}`;
            const storedData = JSON.parse(localStorage.getItem('categoryAppData'));
            
            const entryIndex = storedData.entries[key].findIndex(entry => entry.id == id);
            if (entryIndex !== -1) {
                storedData.entries[key][entryIndex].good = good;
                if (checkStorageSize(storedData)) {
                    localStorage.setItem('categoryAppData', JSON.stringify(storedData));
                }
            }
        }
        
        // Perform search based on input and filters
        function performSearch(category) {
            const searchInput = document.getElementById('search-input');
            const subcategoryFilter = document.getElementById('subcategory-filter');
            const searchText = searchInput.value.toLowerCase();
            const selectedSubcategory = subcategoryFilter.value;
            
            const storedData = JSON.parse(localStorage.getItem('categoryAppData'));
            let results = [];
            
            storedData.subcategories.forEach(subcategory => {
                if (selectedSubcategory !== 'all' && selectedSubcategory !== subcategory) {
                    return;
                }
                
                const key = `${category}-${subcategory}`;
                
                if (!storedData.entries[key]) {
                    return;
                }
                
                storedData.entries[key].forEach(entry => {
                    const displayText = entry.plainText || '';
                    if (searchText === '' || displayText.toLowerCase().includes(searchText)) {
                        results.push({
                            category,
                            subcategory,
                            entry,
                            displayText
                        });
                    }
                });
            });
            
            displaySearchResults(results);
        }
        
        // Display search results
        function displaySearchResults(results) {
            document.getElementById('content-area-grid').style.display = 'none';
            const contentArea = document.getElementById('content-area');
            contentArea.style.display = 'block';
            
            if (results.length === 0) {
                contentArea.innerHTML = `
                    <div class="search-results">
                        <h3>Search Results</h3>
                        <p>No matching entries found.</p>
                        <button class="back-btn" onclick="goBack()">Back</button>
                    </div>
                `;
                return;
            }
            
            let resultsHTML = `
                <div class="search-results">
                    <h3>Search Results (${results.length} found)</h3>
            `;
            
            results.forEach(result => {
                // [XSS Vulnerability] Escape displayText to prevent XSS
                const escapedText = escapeHtml(result.displayText.substring(0, 150));
                resultsHTML += `
                    <div class="result-item ${result.entry.completed ? 'completed' : ''} ${result.entry.good ? 'good' : ''}">
                        <div class="result-header">${result.category} > ${result.subcategory}</div>
                        <div class="result-content">${escapedText}${result.displayText.length > 150 ? '...' : ''}</div>
                        <div class="result-status">
                            Status: ${result.entry.completed ? 'Completed' : 'Active'} ${result.entry.good ? '(Good)' : ''}
                        </div>
                        <button class="view-btn" onclick="selectSubcategory('${result.category}', '${result.subcategory}')">
                            View & Edit
                        </button>
                    </div>
                `;
            });
            
            resultsHTML += `
                <button class="back-btn" onclick="goBack()">Back</button>
            </div>`;
            
            contentArea.innerHTML = resultsHTML;
            
            const resultHeaders = contentArea.querySelectorAll('.result-header');
            resultHeaders.forEach(header => {
                header.innerHTML = header.innerHTML.replace(/Category/g, 'Model').replace(/Subcategory/g, 'Behavior');
            });
        }
        
        // Function to safely go back 
        function goBack() {
            const activeModel = document.querySelector('#categories li.active');
            if (activeModel) {
                selectCategory(activeModel.textContent);
            } else {
                document.getElementById('content-area-grid').style.display = 'flex';
                document.getElementById('content-area').style.display = 'none';
            }
        }
        
        // Update the summary panel - now correctly filtering by model and behavior
        function updateSummary(filterModel = null, filterBehavior = null) {
            const storedData = JSON.parse(localStorage.getItem('categoryAppData'));
            const summaryList = document.getElementById('summary-list');
            
            summaryList.innerHTML = '';
            
            let allEntries = [];
            
            storedData.categories.forEach(category => {
                if (filterModel && category !== filterModel) {
                    return;
                }
                
                storedData.subcategories.forEach(subcategory => {
                    if (filterBehavior && subcategory !== filterBehavior) {
                        return;
                    }
                    
                    const key = `${category}-${subcategory}`;
                    
                    if (storedData.entries[key]) {
                        storedData.entries[key].forEach(entry => {
                            if (!entry.plainText || !entry.plainText.trim()) return;
                            
                            allEntries.push({
                                id: entry.id,
                                category,
                                subcategory,
                                text: entry.plainText,
                                completed: entry.completed,
                                good: entry.good
                            });
                        });
                    }
                });
            });
            
            allEntries.sort((a, b) => {
                if (a.good && !b.good) return -1;
                if (!a.good && b.good) return 1;
                if (a.completed && !b.completed) return 1;
                if (!a.completed && b.completed) return -1;
                return 0;
            });
            
            const maxEntries = Math.min(allEntries.length, 50);
            
            for (let i = 0; i < maxEntries; i++) {
                const entry = allEntries[i];
                const truncatedText = entry.text.length > 100 ? entry.text.substring(0, 100) + '...' : entry.text;
                
                const summaryItem = document.createElement('div');
                summaryItem.className = `summary-item ${entry.completed ? 'completed' : ''} ${entry.good ? 'good' : ''}`;
                summaryItem.dataset.category = entry.category;
                summaryItem.dataset.subcategory = entry.subcategory;
                
                summaryItem.innerHTML = `
                    <div class="summary-content">${truncatedText}</div>
                    <div class="summary-status">
                        <span>
                            ${entry.completed ? '<span class="status-dot completed" title="Completed"></span>' : ''}
                            ${entry.good ? '<span class="status-dot good" title="Marked as good"></span>' : ''}
                        </span>
                    </div>
                `;
                
                summaryItem.addEventListener('click', function() {
                    selectCategory(entry.category);
                    selectSubcategory(entry.category, entry.subcategory);
                    
                    setTimeout(() => {
                        const textBox = document.querySelector(`.text-box[data-id="${entry.id}"]`);
                        if (textBox) {
                            textBox.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            textBox.style.boxShadow = '0 0 0 2px #bb86fc';
                            setTimeout(() => {
                                textBox.style.boxShadow = '';
                            }, 2000);
                        }
                    }, 300);
                });
                
                summaryList.appendChild(summaryItem);
            }
            
            if (allEntries.length === 0) {
                const modelName = filterModel ? filterModel.replace('Category', 'Model') : '';
                summaryList.innerHTML = `<div class="empty-summary">No entries ${modelName ? 'for ' + modelName : ''}. Select a model and behavior to add content.</div>`;
            }
        }
        
        // Export data function
        function exportData() {
            const data = localStorage.getItem('categoryAppData');
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'prompt-manager-backup.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Import data function
        function importData() {
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!importedData.subcategories || importedData.subcategories.length === 0) {
                            importedData.subcategories = defaultData.subcategories;
                        }
                        localStorage.setItem('categoryAppData', JSON.stringify(importedData));
                        alert('Data imported successfully!');
                        window.location.reload();
                    } catch (error) {
                        alert('Error importing data: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }
        
        // Initialize the app
        window.onload = function() {
            populateCategories();
            updateSummary();
            
            document.getElementById('export-btn').addEventListener('click', exportData);
            document.getElementById('import-btn').addEventListener('click', function() {
                document.getElementById('import-file').click();
            });
            document.getElementById('import-file').addEventListener('change', importData);
            
            document.getElementById('add-box-btn').addEventListener('click', () => {
                const activeModel = document.querySelector('#categories li.active')?.textContent;
                const activeBehavior = document.querySelector('#subcategories-side li.active')?.textContent;
                if (activeModel && activeBehavior) {
                    addNewTextBox(activeModel, activeBehavior);
                } else {
                    alert('Please select a model and behavior first.');
                }
            });
            
            const firstModel = defaultData.categories[0];
            if (firstModel) {
                selectCategory(firstModel);
            }
        };
    </script>
</body>
</html>
